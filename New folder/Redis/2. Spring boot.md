# Spring boot

## ¬øC√≥mo funcionar√≠a Redis en tu API?

1. Tu API recibe una solicitud

Un cliente (usuario o frontend) hace una llamada a tu API.

Ejemplo:

GET /products/123

2. Tu API primero consulta Redis

Antes de ir a la base de datos (m√°s lenta), tu API pregunta a Redis:

```PYTHON
producto = redis.get("product:123")
```

- Si Redis tiene el producto (cache hit), ¬°perfecto! ‚Üí Lo devolv√©s al usuario en menos de 1 ms.
- Si Redis no tiene el producto (cache miss), ten√©s que ir a buscarlo...

3. Si Redis no tiene el dato, vas a tu base de datos

Tu API ahora consulta la base de datos (MySQL, PostgreSQL, etc.):

```PYTHON
producto = database.query("SELECT * FROM products WHERE id = 123")
```

Esto puede tardar 100 ms, 200 ms o m√°s.

4. Una vez que ten√©s el dato, lo guard√°s en Redis

Despu√©s de obtener el producto de la base, lo guard√°s en Redis para las pr√≥ximas veces:

```PYTHON
redis.set("product:123", serialize(producto), ex=300)
```

- "ex=300" significa que el dato expira en 5 minutos (300 segundos).
- serialize(producto) es pasar el producto a un formato string, JSON, etc.

5. Devolv√©s la respuesta al cliente

Ahora respond√©s normalmente al cliente con el producto.

6. As√≠ en una pr√≥xima solicitud:

- Primero cheque√°s Redis.
- Si ya estaba, respond√©s r√°pidamente.
- Si no estaba, haces todo el proceso de b√∫squeda y actualizaci√≥n otra vez.

## Uso

### Agregar dependencias en pom.xml

Primero, necesitas agregar la librer√≠a de Spring Data Redis.

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

### Configurar conexi√≥n a Redis en application.properties

Agreg√° las propiedades de conexi√≥n en tu archivo src/main/resources/application.properties:

```
# Indica que queremos usar Redis para la cache
spring.cache.type=redis

# Le decimos a Spring d√≥nde est√° corriendo Redis
spring.data.redis.host=localhost
spring.data.redis.port=6379

# (Opcional) Si tu Redis tiene contrase√±a
# spring.redis.password=tu_clave_redis
```

üëâ ¬øQu√© hace esto?

- spring.cache.type=redis: Le avisa a Spring que no use la cache por defecto en memoria (SimpleCache), sino que use Redis como motor de cach√©.

- localhost:6379: Es la direcci√≥n IP y puerto donde Redis escucha peticiones.

### Crear una configuraci√≥n opcional de RedisTemplate (opcional pero recomendado)

Spring Boot autoconfigura RedisTemplate, pero si quer√©s controlar mejor otros aspectos, pod√©s crear tu propio RedisConfig.java:

```JAVA
@Configuration
@EnableCaching
public class RedisConfig {

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory();
    }

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) {
        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(10));
        return RedisCacheManager.builder(redisConnectionFactory)
                .cacheDefaults(redisCacheConfiguration)
                .build();
    }
}
```

üëâ ¬øQu√© hace esto?

- @Configuration: Marca la clase como una configuraci√≥n de Spring.

- RedisConnectionFactory: Crea la conexi√≥n entre tu aplicaci√≥n y el servidor de Redis. Usa Lettuce, que es un cliente de Redis r√°pido y no bloqueante.

- CacheManager: Define c√≥mo Spring va a administrar las cach√©s. En este caso, configuraste que cada entrada en Redis dure 10 minutos.

- @EnableCaching: Sin esta anotaci√≥n, aunque configures Redis, nunca se activar√≠an las anotaciones @Cacheable o @CacheEvict. Le dice a Spring que empiece a observar las anotaciones relacionadas al cach√© en todos los servicios.

### Usar cach√© en servicios (@Cacheable)

En los m√©todos de PetService, usamos @Cacheable.

Por ejemplo:

```JAVA
@Cacheable(value = "getPublicPets", key = "#speciesList?.toString() + '-' + #age + '-' + #sizeList?.toString() + '-' + #sexList?.toString() + '-' + #pageable.pageNumber")
public Page<PetResponse> getPublicPets(List<String> speciesList,
                                       Integer age,
                                       List<String> sizeList,
                                       List<String> sexList,
                                       Pageable pageable) {
    // l√≥gica del m√©todo...
}
```

üëâ ¬øQu√© hace esto?

- @Cacheable le dice a Spring: "Antes de ejecutar este m√©todo, f√≠jate si ya existe un resultado guardado en Redis con esta llave".

- value = "getPublicPets": Define el nombre del cach√© que va a usar (como una "carpeta" dentro de Redis).

- key = ...: Define c√≥mo armar la clave √∫nica para guardar o buscar en Redis. Combinas filtros como speciesList, age, sizeList, sexList y la p√°gina que se pidi√≥. As√≠ evitas que dos b√∫squedas distintas se pisen entre s√≠.

```JAVA
@Cacheable(value = "getPublicPetById", key = "#id")
public PetResponse getPublicPetById(long id) {
    // l√≥gica del m√©todo...
}
```

üëâ ¬øQu√© hace esto?

- Cachea una mascota individual bas√°ndose en su ID. Si alguien pide el mismo ID, lo devuelve desde Redis, sin tener que ir a la base de datos.

### Invalidar (borrar) la cache cuando cambian datos (@CacheEvict)

Cuando alguien crea, actualiza o elimina una mascota, los datos cacheados quedan desactualizados. Ah√≠ es donde entra @CacheEvict, que elimina una entrada (o todo) de Redis cuando ejecut√°s un m√©todo.

```JAVA
@CacheEvict(value = {"getPublicPets"}, allEntries = true)
public Pet createPet(PetRequest petRequest) {
    // C√≥digo para crear la mascota...
}
```

üëâ ¬øQu√© hace esto?

- value = "getPublicPets": Dice qu√© cach√© afectar.

- allEntries = true: Borra todas las entradas del cach√© getPublicPets, porque una nueva mascota podr√≠a afectar cualquier p√°gina o filtro.

```JAVA
@CacheEvict(value = {"getPublicPetById"}, key = "#id")
public Pet updatePet(long id, PetRequest petRequest) {
    // C√≥digo para actualizar la mascota...
}
```

üëâ ¬øQu√© hace esto?

- Solo borra el cach√© de la mascota con ese ID, no todo el cach√© de mascotas.

### Actualizar el cache manualmente (@CachePut)

Si quer√©s ser a√∫n m√°s fino, pod√©s actualizar el cach√© en vez de solo borrarlo cuando se actualiza algo.
Para eso existe @CachePut.

```JAVA
@CachePut(value = "getPublicPetById", key = "#id")
public PetResponse updatePet(long id, PetRequest petRequest) {
    // C√≥digo para actualizar la mascota...
}
```

üëâ ¬øQu√© hace esto?

- Ejecuta el m√©todo normal (actualiza DB).

- El resultado se guarda autom√°ticamente en Redis, reemplazando el viejo.

